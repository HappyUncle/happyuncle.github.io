<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>TiProxy 原理和实现 - C4H</title><meta name=Description content="code for happy"><meta property="og:title" content="TiProxy 原理和实现"><meta property="og:description" content="说明在上篇《TiProxy 尝鲜》中做了一些实验，比如加减tidb节点后tiproxy可以做到自动负载均衡，如果遇到会话有未提交的事务则等待事"><meta property="og:type" content="article"><meta property="og:url" content="/tiproxy-yuan-li-he-shi-xian/"><meta property="og:image" content="/avatar.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-30T13:20:35+08:00"><meta property="article:modified_time" content="2023-07-30T13:20:35+08:00"><meta property="og:site_name" content="C4H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/avatar.jpeg"><meta name=twitter:title content="TiProxy 原理和实现"><meta name=twitter:description content="说明在上篇《TiProxy 尝鲜》中做了一些实验，比如加减tidb节点后tiproxy可以做到自动负载均衡，如果遇到会话有未提交的事务则等待事"><meta name=application-name content="C4H"><meta name=apple-mobile-web-app-title content="C4H"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=/tiproxy-yuan-li-he-shi-xian/><link rel=prev href=/try-tiproxy/><link rel=next href=/tidb-you-ya-guan-bi/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"TiProxy 原理和实现","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"\/tiproxy-yuan-li-he-shi-xian\/"},"genre":"posts","keywords":"tidb, database, tiproxy","wordcount":4341,"url":"\/tiproxy-yuan-li-he-shi-xian\/","datePublished":"2023-07-30T13:20:35+08:00","dateModified":"2023-07-30T13:20:35+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"happyuncle"},"description":""}</script><script src=//instant.page/5.1.1 defer type=module integrity=sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq></script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark")}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"||"auto"==="black"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")]</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=C4H><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=# class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=# class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=C4H><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=# class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a>
<a href=# class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=# class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=# class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class="toc-content always-active" id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#说明>说明</a></li><li><a href=#tiproxy-介绍>Tiproxy 介绍</a></li><li><a href=#声明>声明</a></li><li><a href=#原理分析>原理分析</a><ul><li><a href=#1tiproxy是怎么发现tidb>1、tiproxy是怎么发现tidb？</a><ul><li><a href=#第一步获取>第一步获取：</a></li><li><a href=#第二步检查>第二步检查：</a></li><li><a href=#第三步通知>第三步通知：</a></li></ul></li><li><a href=#2tiproxy是在tidb节点间自动负载均衡的逻辑>2、tiproxy是在tidb节点间自动负载均衡的逻辑？</a><ul><li><a href=#rebalance-的逻辑>rebalance 的逻辑</a></li></ul></li><li><a href=#3在自动负载均衡时tiproxy是怎么做到优雅的session迁移session上下文恢复>3、在自动负载均衡时tiproxy是怎么做到优雅的session迁移、session上下文恢复？</a><ul><li><a href=#迁移消息接收>迁移消息接收</a></li><li><a href=#迁移任务执行>迁移任务执行</a></li></ul></li><li><a href=#4tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的>4、tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的？</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#彩蛋>彩蛋</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">TiProxy 原理和实现</h1><div class=post-meta><div class=post-meta-line><span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=/ title=Author rel=author class=author>happyuncle</a>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tidb/><i class="far fa-folder fa-fw"></i>tidb</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-07-30>2023-07-30</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-07-30>2023-07-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4341 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 9 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#说明>说明</a></li><li><a href=#tiproxy-介绍>Tiproxy 介绍</a></li><li><a href=#声明>声明</a></li><li><a href=#原理分析>原理分析</a><ul><li><a href=#1tiproxy是怎么发现tidb>1、tiproxy是怎么发现tidb？</a><ul><li><a href=#第一步获取>第一步获取：</a></li><li><a href=#第二步检查>第二步检查：</a></li><li><a href=#第三步通知>第三步通知：</a></li></ul></li><li><a href=#2tiproxy是在tidb节点间自动负载均衡的逻辑>2、tiproxy是在tidb节点间自动负载均衡的逻辑？</a><ul><li><a href=#rebalance-的逻辑>rebalance 的逻辑</a></li></ul></li><li><a href=#3在自动负载均衡时tiproxy是怎么做到优雅的session迁移session上下文恢复>3、在自动负载均衡时tiproxy是怎么做到优雅的session迁移、session上下文恢复？</a><ul><li><a href=#迁移消息接收>迁移消息接收</a></li><li><a href=#迁移任务执行>迁移任务执行</a></li></ul></li><li><a href=#4tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的>4、tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的？</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#彩蛋>彩蛋</a></li></ul></nav></div></div><div class=content id=content><hr><h2 id=说明 class=headerLink><a href=#%e8%af%b4%e6%98%8e class=header-mark></a>说明</h2><p>在上篇<a href=https://tidb.net/blog/bbf3f52d target=_blank rel="noopener noreferrer">《TiProxy 尝鲜》</a>中做了一些实验，比如加减tidb节点后tiproxy可以做到自动负载均衡，如果遇到会话有未提交的事务则等待事务结束才迁移。</p><p>本次主要研究这样的功能在tiproxy中是如何实现的，本次分享内容主要为以下几部分：</p><ul><li>tiproxy是怎么发现tidb？</li><li>tiproxy是在tidb节点间自动负载均衡的逻辑？</li><li>在自动负载均衡时tiproxy是怎么做到优雅的session迁移、session上下文恢复？</li><li>tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的？</li></ul><h2 id=tiproxy-介绍 class=headerLink><a href=#tiproxy-%e4%bb%8b%e7%bb%8d class=header-mark></a>Tiproxy 介绍</h2><p>tiproxy 在 <a href=https://docs.pingcap.com/zh/tidb-in-kubernetes/stable/release-1.4.0-beta.3 target=_blank rel="noopener noreferrer">2022年12月2日被operator支持</a></p><p><a class=lightgallery href=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png title=Img data-thumbnail=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png><img loading=lazy src=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png srcset="/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png, /images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png 1.5x, /images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png 2x" sizes=auto alt=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730133043.png></a></p><p>相关的设计文档可以从官方 <a href=https://github.com/pingcap/tidb/blob/master/docs/design/2022-07-20-session-manager.md target=_blank rel="noopener noreferrer">README</a> 和 <a href="https://docs.google.com/document/d/10c1tXP8B_AwgHMp_A2EuS83I5gz2QL1nH-EPwRdGScM/edit?pli=1" target=_blank rel="noopener noreferrer">goole doc</a> 中查看</p><p>这个有个重要特性需要说明下：</p><ul><li>tiproxy组件不会保存账号的密码，因为这是不安全的行为，所以当进行会话迁移的时候使用的是 session token 认证方式(下文会提到这种方式的实现原理)。</li></ul><h2 id=声明 class=headerLink><a href=#%e5%a3%b0%e6%98%8e class=header-mark></a>声明</h2><p>目前tiproxy还处于实验阶段、功能还在持续开发中，本文讲述的内容跟日后GA版本可能存在差异，届时请各位看官留意。</p><p>另外本人能力有限，在阅读源码中难免有理解不到位的地方，如有发现欢迎在评论区指正，感谢。</p><p>开始发车</p><h2 id=原理分析 class=headerLink><a href=#%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90 class=header-mark></a>原理分析</h2><h3 id=1tiproxy是怎么发现tidb class=headerLink><a href=#1tiproxy%e6%98%af%e6%80%8e%e4%b9%88%e5%8f%91%e7%8e%b0tidb class=header-mark></a>1、tiproxy是怎么发现tidb？</h3><p>获取tidb拓扑最核心、简化后的代码如下，其实就是使用etcdCli.Get获取信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=c1>// 从 etcd 获取 tidb 拓扑 路径 /topology/tidb/&lt;ip:port&gt;/info /topology/tidb/&lt;ip:port&gt;/ttl
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>is</span> <span class=o>*</span><span class=nx>InfoSyncer</span><span class=p>)</span> <span class=nf>GetTiDBTopology</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>TiDBInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>is</span><span class=p>.</span><span class=nx>etcdCli</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>tidbinfo</span><span class=p>.</span><span class=nx>TopologyInformationPath</span><span class=p>,</span> <span class=nx>clientv3</span><span class=p>.</span><span class=nf>WithPrefix</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=nx>infos</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>TiDBInfo</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>Kvs</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>kv</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>res</span><span class=p>.</span><span class=nx>Kvs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>ttl</span><span class=p>,</span> <span class=nx>addr</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>topology</span> <span class=o>*</span><span class=nx>tidbinfo</span><span class=p>.</span><span class=nx>TopologyInfo</span>
</span></span><span class=line><span class=cl>        <span class=nx>key</span> <span class=o>:=</span> <span class=nx>hack</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>kv</span><span class=p>.</span><span class=nx>Key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>HasSuffix</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>ttlSuffix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nx>addr</span> <span class=p>=</span> <span class=nx>key</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>tidbinfo</span><span class=p>.</span><span class=nx>TopologyInformationPath</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span> <span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=nx>ttlSuffix</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nx>ttl</span> <span class=p>=</span> <span class=nx>hack</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>kv</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>strings</span><span class=p>.</span><span class=nf>HasSuffix</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>infoSuffix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=nx>addr</span> <span class=p>=</span> <span class=nx>key</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=nx>tidbinfo</span><span class=p>.</span><span class=nx>TopologyInformationPath</span><span class=p>)</span><span class=o>+</span><span class=mi>1</span> <span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span><span class=o>-</span><span class=nb>len</span><span class=p>(</span><span class=nx>infoSuffix</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nx>json</span><span class=p>.</span><span class=nf>Unmarshal</span><span class=p>(</span><span class=nx>kv</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>topology</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>info</span> <span class=o>:=</span> <span class=nx>infos</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ttl</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>info</span><span class=p>.</span><span class=nx>TTL</span> <span class=p>=</span> <span class=nx>hack</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=nx>kv</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>info</span><span class=p>.</span><span class=nx>TopologyInfo</span> <span class=p>=</span> <span class=nx>topology</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>infos</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这个函数是怎么被tiproxy用起来的呢？</p><p>其实在每个proxy启动时后都会开启一个BackendObserver协程，这个协程会做三件事：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>bo</span> <span class=o>*</span><span class=nx>BackendObserver</span><span class=p>)</span> <span class=nf>observe</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>ctx</span><span class=p>.</span><span class=nf>Err</span><span class=p>()</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 获取
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>backendInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>bo</span><span class=p>.</span><span class=nx>fetcher</span><span class=p>.</span><span class=nf>GetBackendList</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 检查
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>bhMap</span> <span class=o>:=</span> <span class=nx>bo</span><span class=p>.</span><span class=nf>checkHealth</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>backendInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通知
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>bo</span><span class=p>.</span><span class=nf>notifyIfChanged</span><span class=p>(</span><span class=nx>bhMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>bo</span><span class=p>.</span><span class=nx>healthCheckConfig</span><span class=p>.</span><span class=nx>Interval</span><span class=p>):</span>  <span class=c1>// 间隔3秒
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>bo</span><span class=p>.</span><span class=nx>refreshChan</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=第一步获取 class=headerLink><a href=#%e7%ac%ac%e4%b8%80%e6%ad%a5%e8%8e%b7%e5%8f%96 class=header-mark></a>第一步获取：</h4><p>从etcd获取tidb拓扑；代码见上；</p><h4 id=第二步检查 class=headerLink><a href=#%e7%ac%ac%e4%ba%8c%e6%ad%a5%e6%a3%80%e6%9f%a5 class=header-mark></a>第二步检查：</h4><p>判断获取到tidb节点是否可以连通、访问，给每个节点设置StatusHealthy或者StatusCannotConnect状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>bo</span> <span class=o>*</span><span class=nx>BackendObserver</span><span class=p>)</span> <span class=nf>checkHealth</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>backends</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>BackendInfo</span><span class=p>)</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>backendHealth</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>curBackendHealth</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>backendHealth</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>backends</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>info</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>backends</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>bh</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>backendHealth</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=p>:</span> <span class=nx>StatusHealthy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>curBackendHealth</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span> <span class=p>=</span> <span class=nx>bh</span>
</span></span><span class=line><span class=cl>        <span class=c1>// http 服务检查
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=nx>info</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>info</span><span class=p>.</span><span class=nx>IP</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>schema</span> <span class=o>:=</span> <span class=s>&#34;http&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nx>httpCli</span> <span class=o>:=</span> <span class=o>*</span><span class=nx>bo</span><span class=p>.</span><span class=nx>httpCli</span>
</span></span><span class=line><span class=cl>            <span class=nx>httpCli</span><span class=p>.</span><span class=nx>Timeout</span> <span class=p>=</span> <span class=nx>bo</span><span class=p>.</span><span class=nx>healthCheckConfig</span><span class=p>.</span><span class=nx>DialTimeout</span>
</span></span><span class=line><span class=cl>            <span class=nx>url</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s://%s:%d%s&#34;</span><span class=p>,</span> <span class=nx>schema</span><span class=p>,</span> <span class=nx>info</span><span class=p>.</span><span class=nx>IP</span><span class=p>,</span> <span class=nx>info</span><span class=p>.</span><span class=nx>StatusPort</span><span class=p>,</span> <span class=nx>statusPathSuffix</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>resp</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>httpCli</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>bh</span><span class=p>.</span><span class=nx>status</span> <span class=p>=</span> <span class=nx>StatusCannotConnect</span>
</span></span><span class=line><span class=cl>                <span class=nx>bh</span><span class=p>.</span><span class=nx>pingErr</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Wrapf</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;connect status port failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// tcp 服务检查
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>DialTimeout</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>bo</span><span class=p>.</span><span class=nx>healthCheckConfig</span><span class=p>.</span><span class=nx>DialTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>bh</span><span class=p>.</span><span class=nx>status</span> <span class=p>=</span> <span class=nx>StatusCannotConnect</span>
</span></span><span class=line><span class=cl>            <span class=nx>bh</span><span class=p>.</span><span class=nx>pingErr</span> <span class=p>=</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>Wrapf</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;connect sql port failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>        
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>curBackendHealth</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=第三步通知 class=headerLink><a href=#%e7%ac%ac%e4%b8%89%e6%ad%a5%e9%80%9a%e7%9f%a5 class=header-mark></a>第三步通知：</h4><p>将检查后的 backends 列表跟内存中缓存的 backends 进行比较，将变动的 updatedBackends 进行通知</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// notifyIfChanged 根据最新的 tidb 拓扑 bhMap 与之前的 tidb 拓扑 bo.curBackendInfo 进行比较
</span></span></span><span class=line><span class=cl><span class=c1>// - 在 bo.curBackendInfo 中但是不在 bhMap 中：说明 tidb 节点失联，需要记录下
</span></span></span><span class=line><span class=cl><span class=c1>// - 在 bo.curBackendInfo 中也在 bhMap 中，但是最新的状态不是 StatusHealthy：也需要记录下
</span></span></span><span class=line><span class=cl><span class=c1>// - 在 bhMap 中但是不在 bo.curBackendInfo 中：说明是新增 tidb 节点，需要记录下
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>bo</span> <span class=o>*</span><span class=nx>BackendObserver</span><span class=p>)</span> <span class=nf>notifyIfChanged</span><span class=p>(</span><span class=nx>bhMap</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>backendHealth</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>updatedBackends</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>backendHealth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>lastHealth</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>bo</span><span class=p>.</span><span class=nx>curBackendInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>lastHealth</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=nx>StatusHealthy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>newHealth</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>bhMap</span><span class=p>[</span><span class=nx>addr</span><span class=p>];</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>updatedBackends</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>backendHealth</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>status</span><span class=p>:</span>  <span class=nx>StatusCannotConnect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nx>pingErr</span><span class=p>:</span> <span class=nx>errors</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;removed from backend list&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nf>updateBackendStatusMetrics</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>lastHealth</span><span class=p>.</span><span class=nx>status</span><span class=p>,</span> <span class=nx>StatusCannotConnect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>newHealth</span><span class=p>.</span><span class=nx>status</span> <span class=o>!=</span> <span class=nx>StatusHealthy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>updatedBackends</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span> <span class=p>=</span> <span class=nx>newHealth</span>
</span></span><span class=line><span class=cl>                <span class=nf>updateBackendStatusMetrics</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>lastHealth</span><span class=p>.</span><span class=nx>status</span><span class=p>,</span> <span class=nx>newHealth</span><span class=p>.</span><span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>addr</span><span class=p>,</span> <span class=nx>newHealth</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>bhMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>newHealth</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=nx>StatusHealthy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>lastHealth</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>bo</span><span class=p>.</span><span class=nx>curBackendInfo</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>lastHealth</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>backendHealth</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nx>status</span><span class=p>:</span> <span class=nx>StatusCannotConnect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>lastHealth</span><span class=p>.</span><span class=nx>status</span> <span class=o>!=</span> <span class=nx>StatusHealthy</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>updatedBackends</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span> <span class=p>=</span> <span class=nx>newHealth</span>
</span></span><span class=line><span class=cl>                <span class=nf>updateBackendStatusMetrics</span><span class=p>(</span><span class=nx>addr</span><span class=p>,</span> <span class=nx>lastHealth</span><span class=p>.</span><span class=nx>status</span><span class=p>,</span> <span class=nx>newHealth</span><span class=p>.</span><span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>lastHealth</span><span class=p>.</span><span class=nx>serverVersion</span> <span class=o>!=</span> <span class=nx>newHealth</span><span class=p>.</span><span class=nx>serverVersion</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Not possible here: the backend finishes upgrading between two health checks.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>updatedBackends</span><span class=p>[</span><span class=nx>addr</span><span class=p>]</span> <span class=p>=</span> <span class=nx>newHealth</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Notify it even when the updatedBackends is empty, in order to clear the last error.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>bo</span><span class=p>.</span><span class=nx>eventReceiver</span><span class=p>.</span><span class=nf>OnBackendChanged</span><span class=p>(</span><span class=nx>updatedBackends</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>bo</span><span class=p>.</span><span class=nx>curBackendInfo</span> <span class=p>=</span> <span class=nx>bhMap</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过上面的步骤就获取到了变动的backends，将这些变动从 BackendObserver 模块同步给 ScoreBasedRouter 模块。</p><h3 id=2tiproxy是在tidb节点间自动负载均衡的逻辑 class=headerLink><a href=#2tiproxy%e6%98%af%e5%9c%a8tidb%e8%8a%82%e7%82%b9%e9%97%b4%e8%87%aa%e5%8a%a8%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e7%9a%84%e9%80%bb%e8%be%91 class=header-mark></a>2、tiproxy是在tidb节点间自动负载均衡的逻辑？</h3><p>此处自动负载的语义是：将哪个 backend 的哪个 connect 迁移到哪个 backend 上。这就要解决 backend 挑选和 connect 挑选问题。</p><p>这个问题的解决办法是在 ScoreBasedRouter 模块完成。这个模块有3个 func 和上述解释相关：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ScoreBasedRouter</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>    <span class=c1>// A list of *backendWrapper. The backends are in descending order of scores.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>backends</span>     <span class=o>*</span><span class=nx>glist</span><span class=p>.</span><span class=nx>List</span><span class=p>[</span><span class=o>*</span><span class=nx>backendWrapper</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 被 BackendObserver 调用，传来的 backends 会合并到 ScoreBasedRouter::backends 中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>router</span> <span class=o>*</span><span class=nx>ScoreBasedRouter</span><span class=p>)</span> <span class=nf>OnBackendChanged</span><span class=p>(</span><span class=nx>backends</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>backendHealth</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 通过比较 backend 分数方式调整 ScoreBasedRouter::backends 中的位置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>router</span> <span class=o>*</span><span class=nx>ScoreBasedRouter</span><span class=p>)</span> <span class=nf>adjustBackendList</span><span class=p>(</span><span class=nx>be</span> <span class=o>*</span><span class=nx>glist</span><span class=p>.</span><span class=nx>Element</span><span class=p>[</span><span class=o>*</span><span class=nx>backendWrapper</span><span class=p>])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 协程方式运行，做负载均衡处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>router</span> <span class=o>*</span><span class=nx>ScoreBasedRouter</span><span class=p>)</span> <span class=nf>rebalanceLoop</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>OnBackendChanged 是暴露给 BackendObserver 模块的一个接口， 用来同步从 etcd 发现的 tidb 信息，这个逻辑不复杂，详细可自行阅读源码。这个方法是问题一种提到的“通知”接收处。</p><p>adjustBackendList 本质就是调整 item 在双向链表中的位置，这个也不复杂。</p><p>下面重点说下 rebalanceLoop 的逻辑，这里涉及到"将哪个 backend 的哪个 connect 迁移到哪个 backend 上"的问题。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// rebalanceLoop 计算间隔是 10 ms，每次最多处理 10 个连接(防止后端出现抖动)
</span></span></span><span class=line><span class=cl><span class=c1>// - backends 的变化是通过 OnBackendChanged 修改的，连接平衡是 rebalanceLoop 函数做的，两者为了保证并发使用了 sync.Mutex
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>router</span> <span class=o>*</span><span class=nx>ScoreBasedRouter</span><span class=p>)</span> <span class=nf>rebalanceLoop</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nf>rebalance</span><span class=p>(</span><span class=nx>rebalanceConnsPerLoop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>rebalanceInterval</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// rebalance
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>router</span> <span class=o>*</span><span class=nx>ScoreBasedRouter</span><span class=p>)</span> <span class=nf>rebalance</span><span class=p>(</span><span class=nx>maxNum</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>curTime</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>router</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>router</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>maxNum</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>busiestEle</span> <span class=o>*</span><span class=nx>glist</span><span class=p>.</span><span class=nx>Element</span><span class=p>[</span><span class=o>*</span><span class=nx>backendWrapper</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>be</span> <span class=o>:=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>backends</span><span class=p>.</span><span class=nf>Front</span><span class=p>();</span> <span class=nx>be</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>;</span> <span class=nx>be</span> <span class=p>=</span> <span class=nx>be</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>backend</span> <span class=o>:=</span> <span class=nx>be</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>backend</span><span class=p>.</span><span class=nx>connList</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>busiestEle</span> <span class=p>=</span> <span class=nx>be</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>busiestEle</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>busiestBackend</span> <span class=o>:=</span> <span class=nx>busiestEle</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>        <span class=nx>idlestEle</span> <span class=o>:=</span> <span class=nx>router</span><span class=p>.</span><span class=nx>backends</span><span class=p>.</span><span class=nf>Back</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>idlestBackend</span> <span class=o>:=</span> <span class=nx>idlestEle</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>busiestBackend</span><span class=p>.</span><span class=nf>score</span><span class=p>())</span><span class=o>/</span><span class=nb>float64</span><span class=p>(</span><span class=nx>idlestBackend</span><span class=p>.</span><span class=nf>score</span><span class=p>()</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>rebalanceMaxScoreRatio</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>ce</span> <span class=o>*</span><span class=nx>glist</span><span class=p>.</span><span class=nx>Element</span><span class=p>[</span><span class=o>*</span><span class=nx>connWrapper</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>ele</span> <span class=o>:=</span> <span class=nx>busiestBackend</span><span class=p>.</span><span class=nx>connList</span><span class=p>.</span><span class=nf>Front</span><span class=p>();</span> <span class=nx>ele</span> <span class=o>!=</span> <span class=kc>nil</span><span class=p>;</span> <span class=nx>ele</span> <span class=p>=</span> <span class=nx>ele</span><span class=p>.</span><span class=nf>Next</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>conn</span> <span class=o>:=</span> <span class=nx>ele</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=nx>conn</span><span class=p>.</span><span class=nx>phase</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>phaseRedirectNotify</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>phaseRedirectFail</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>conn</span><span class=p>.</span><span class=nx>lastRedirect</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>redirectFailMinInterval</span><span class=p>).</span><span class=nf>After</span><span class=p>(</span><span class=nx>curTime</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>continue</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>ce</span> <span class=p>=</span> <span class=nx>ele</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ce</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>conn</span> <span class=o>:=</span> <span class=nx>ce</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>        <span class=nx>busiestBackend</span><span class=p>.</span><span class=nx>connScore</span><span class=o>--</span>
</span></span><span class=line><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nf>adjustBackendList</span><span class=p>(</span><span class=nx>busiestEle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>idlestBackend</span><span class=p>.</span><span class=nx>connScore</span><span class=o>++</span>
</span></span><span class=line><span class=cl>        <span class=nx>router</span><span class=p>.</span><span class=nf>adjustBackendList</span><span class=p>(</span><span class=nx>idlestEle</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>conn</span><span class=p>.</span><span class=nx>phase</span> <span class=p>=</span> <span class=nx>phaseRedirectNotify</span>
</span></span><span class=line><span class=cl>        <span class=nx>conn</span><span class=p>.</span><span class=nx>lastRedirect</span> <span class=p>=</span> <span class=nx>curTime</span>
</span></span><span class=line><span class=cl>        <span class=nx>conn</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=nx>idlestBackend</span><span class=p>.</span><span class=nx>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=rebalance-的逻辑 class=headerLink><a href=#rebalance-%e7%9a%84%e9%80%bb%e8%be%91 class=header-mark></a>rebalance 的逻辑</h4><ul><li>从前往后访问 backends list，找到 busiestBackend</li><li>在 backends list 最后找到 idlestBackend</li><li>比较两者 score， 如果差距在 20% 以内就不用处理了</li><li>否则在 busiestBackend 中取出一个 conn 给 idlestBackend<ul><li>取出的逻辑很简单，就是从前到后遍历当前 backend 的 connList</li><li>因为session迁移要保证事务完成，所以迁移不是立刻执行的，这就得加个 phase 来跟进<ul><li>处于 phaseRedirectNotify 阶段的不要再取出；</li><li>处于 phaseRedirectFail 但还没到超时时间的，也不要取出；</li></ul></li><li>其他状态的 conn 可以被取出</li></ul></li><li>因为有 conn 变动所以要调整下 busiestBackend 和 idlestBackend 在 backends list 中的位置</li><li>最后通过 channel 通知 BackendConnManager 做去session迁移，此时 conn 状态是 phaseRedirectNotify</li></ul><p>给每个backend的打分逻辑如下，分数越大说明负载越大</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>b</span> <span class=o>*</span><span class=nx>backendWrapper</span><span class=p>)</span> <span class=nf>score</span><span class=p>()</span> <span class=kt>int</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>b</span><span class=p>.</span><span class=nx>status</span><span class=p>.</span><span class=nf>ToScore</span><span class=p>()</span> <span class=o>+</span> <span class=nx>b</span><span class=p>.</span><span class=nx>connScore</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// var statusScores = map[BackendStatus]int{
</span></span></span><span class=line><span class=cl><span class=c1>//     StatusHealthy:        0,
</span></span></span><span class=line><span class=cl><span class=c1>//     StatusCannotConnect:  10000000,
</span></span></span><span class=line><span class=cl><span class=c1>//     StatusMemoryHigh:     5000,
</span></span></span><span class=line><span class=cl><span class=c1>//     StatusRunSlow:        5000,
</span></span></span><span class=line><span class=cl><span class=c1>//     StatusSchemaOutdated: 10000000,
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1>// connScore = connList.Len() + incoming connections - outgoing connections.
</span></span></span></code></pre></td></tr></table></div></div><h3 id=3在自动负载均衡时tiproxy是怎么做到优雅的session迁移session上下文恢复 class=headerLink><a href=#3%e5%9c%a8%e8%87%aa%e5%8a%a8%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e6%97%b6tiproxy%e6%98%af%e6%80%8e%e4%b9%88%e5%81%9a%e5%88%b0%e4%bc%98%e9%9b%85%e7%9a%84session%e8%bf%81%e7%a7%bbsession%e4%b8%8a%e4%b8%8b%e6%96%87%e6%81%a2%e5%a4%8d class=header-mark></a>3、在自动负载均衡时tiproxy是怎么做到优雅的session迁移、session上下文恢复？</h3><p>这个问题可以继续细分：</p><ul><li>迁移消息接收<ul><li>ScoreBasedRouter 模块计算出哪个 conn 从哪个 backend 迁移到哪个 backend 后，怎么通知给对应的 conn ？</li></ul></li><li>迁移任务执行<ul><li>conn 接收到消息后要进行session迁移，那么如何解决迁移期间 client 可能存在访问的问题 ？</li><li>因为tiproxy没有保存密码，那么基于session token的验证方式是怎么实现的？</li><li>新的tidb节点登录成功后，session上下问题信息是怎么恢复的？</li></ul></li></ul><p>以上的问题都可以在 BackendConnManager 模块找到答案：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>BackendConnManager</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// processLock makes redirecting and command processing exclusive.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>processLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>clientIO</span>   <span class=o>*</span><span class=nx>pnet</span><span class=p>.</span><span class=nx>PacketIO</span>
</span></span><span class=line><span class=cl>    <span class=nx>backendIO</span>        <span class=nx>atomic</span><span class=p>.</span><span class=nx>Pointer</span><span class=p>[</span><span class=nx>pnet</span><span class=p>.</span><span class=nx>PacketIO</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>authenticator</span>  <span class=o>*</span><span class=nx>Authenticator</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>Redirect</span><span class=p>(</span><span class=nx>newAddr</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>processSignals</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>tryRedirect</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>querySessionStates</span><span class=p>(</span><span class=nx>backendIO</span> <span class=o>*</span><span class=nx>pnet</span><span class=p>.</span><span class=nx>PacketIO</span><span class=p>)</span> <span class=p>(</span><span class=nx>sessionStates</span><span class=p>,</span> <span class=nx>sessionToken</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>ExecuteCmd</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=迁移消息接收 class=headerLink><a href=#%e8%bf%81%e7%a7%bb%e6%b6%88%e6%81%af%e6%8e%a5%e6%94%b6 class=header-mark></a>迁移消息接收</h4><p>在前文的 rebalance 方法最后，有行这样的逻辑</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>    <span class=nx>conn</span><span class=p>.</span><span class=nf>Redirect</span><span class=p>(</span><span class=nx>idlestBackend</span><span class=p>.</span><span class=nx>addr</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这就是 ScoreBasedRouter 的通知给对应 conn 的地方。</p><p>这里调用的是 BackendConnManager::Redirect， 具体执行逻辑</p><ul><li>将目标 backend 存储到 redirectInfo</li><li>给 signalReceived channel 发 signalTypeRedirect 消息</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>Redirect</span><span class=p>(</span><span class=nx>newAddr</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// NOTE: BackendConnManager may be closing concurrently because of no lock.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>switch</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>closeStatus</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>statusNotifyClose</span><span class=p>,</span> <span class=nx>statusClosing</span><span class=p>,</span> <span class=nx>statusClosed</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>mgr</span><span class=p>.</span><span class=nx>redirectInfo</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>signalRedirect</span><span class=p>{</span><span class=nx>newAddr</span><span class=p>:</span> <span class=nx>newAddr</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Generally, it won&#39;t wait because the caller won&#39;t send another signal before the previous one finishes.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>mgr</span><span class=p>.</span><span class=nx>signalReceived</span> <span class=o>&lt;-</span> <span class=nx>signalTypeRedirect</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>该消息被 BackendConnManager::processSignals 协程接收</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>processSignals</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>s</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>mgr</span><span class=p>.</span><span class=nx>signalReceived</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Redirect the session immediately just in case the session is finishedTxn.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>mgr</span><span class=p>.</span><span class=nx>processLock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>switch</span> <span class=nx>s</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>signalTypeGracefulClose</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>mgr</span><span class=p>.</span><span class=nf>tryGracefulClose</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>case</span> <span class=nx>signalTypeRedirect</span><span class=p>:</span>   <span class=c1>// &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>mgr</span><span class=p>.</span><span class=nf>tryRedirect</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>   
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>mgr</span><span class=p>.</span><span class=nx>processLock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nx>rs</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>mgr</span><span class=p>.</span><span class=nx>redirectResCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>mgr</span><span class=p>.</span><span class=nf>notifyRedirectResult</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>rs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>mgr</span><span class=p>.</span><span class=nx>checkBackendTicker</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>mgr</span><span class=p>.</span><span class=nf>checkBackendActive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这里补充下 processSignals 是怎么来的。正常情况下，client每发起一个连接，proxy就会起两个协程：</p><ul><li>连接、转发 tcp 消息协程：<ul><li>连接：SQLServer::Run 方法启动，也就是每连接每协程的意思。</li><li>转发：ClientConnection 模块调用 BackendConnManager::ExecuteCmd 实现消息转发</li></ul></li><li>监听和执行 redirect 任务协程：<ul><li>BackendConnManager 模块启动 processSignals 协程处理</li></ul></li></ul><p>所以上文监听 signalTypeRedirect 消息的 processSignals 协程，在连接建立时就启动了，当收到消息后执行 tryRedirect 方法尝试执行迁移。</p><h4 id=迁移任务执行 class=headerLink><a href=#%e8%bf%81%e7%a7%bb%e4%bb%bb%e5%8a%a1%e6%89%a7%e8%a1%8c class=header-mark></a>迁移任务执行</h4><p>tryRedirect 处理逻辑比较复杂，我们选取核心流程进行简述：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>tryRedirect</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获取目标 backend
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>signal</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>redirectInfo</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处于事务中，先不做迁移
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>!</span><span class=nx>mgr</span><span class=p>.</span><span class=nx>cmdProcessor</span><span class=p>.</span><span class=nf>finishedTxn</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 组装执行结果
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>rs</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>redirectResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>from</span><span class=p>:</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>ServerAddr</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>to</span><span class=p>:</span>   <span class=nx>signal</span><span class=p>.</span><span class=nx>newAddr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 不论执行成功与否都清空 redirectInfo， 并将 rs 结果发到 redirectResCh， redirectResCh 的处理逻辑还是在 processSignals 中处理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>mgr</span><span class=p>.</span><span class=nx>redirectInfo</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>mgr</span><span class=p>.</span><span class=nx>redirectResCh</span> <span class=o>&lt;-</span> <span class=nx>rs</span>
</span></span><span class=line><span class=cl>    <span class=p>}()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从源 backend 获取 sessionStates, sessionToken
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>backendIO</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>backendIO</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>sessionStates</span><span class=p>,</span> <span class=nx>sessionToken</span><span class=p>,</span> <span class=nx>rs</span><span class=p>.</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>querySessionStates</span><span class=p>(</span><span class=nx>backendIO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 跟目标 backend 建立tcp连接
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>cn</span><span class=p>,</span> <span class=nx>rs</span><span class=p>.</span><span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>DialTimeout</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>rs</span><span class=p>.</span><span class=nx>to</span><span class=p>,</span> <span class=nx>DialTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将 conn 包裹为 PacketIO
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>newBackendIO</span> <span class=o>:=</span> <span class=nx>pnet</span><span class=p>.</span><span class=nf>NewPacketIO</span><span class=p>(</span><span class=nx>cn</span><span class=p>,</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>pnet</span><span class=p>.</span><span class=nf>WithRemoteAddr</span><span class=p>(</span><span class=nx>rs</span><span class=p>.</span><span class=nx>to</span><span class=p>,</span> <span class=nx>cn</span><span class=p>.</span><span class=nf>RemoteAddr</span><span class=p>()),</span> <span class=nx>pnet</span><span class=p>.</span><span class=nf>WithWrapError</span><span class=p>(</span><span class=nx>ErrBackendConn</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用 session token方式跟目标 backend 进行鉴握手鉴权
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>mgr</span><span class=p>.</span><span class=nx>authenticator</span><span class=p>.</span><span class=nf>handshakeSecondTime</span><span class=p>(</span><span class=nx>mgr</span><span class=p>.</span><span class=nx>logger</span><span class=p>,</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>clientIO</span><span class=p>,</span> <span class=nx>newBackendIO</span><span class=p>,</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>backendTLS</span><span class=p>,</span> <span class=nx>sessionToken</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 登录目标 backend 进行鉴权
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>rs</span><span class=p>.</span><span class=nx>err</span> <span class=p>=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nf>initSessionStates</span><span class=p>(</span><span class=nx>newBackendIO</span><span class=p>,</span> <span class=nx>sessionStates</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将新的 PacketIO 存储到 BackendConnManager 的成员变量中，后续再有请求都是用此变量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>mgr</span><span class=p>.</span><span class=nx>backendIO</span><span class=p>.</span><span class=nf>Store</span><span class=p>(</span><span class=nx>newBackendIO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>上面展示了 session token 的认证方式和上下文恢复的逻辑，对应 querySessionStates 、handshakeSecondTime 、initSessionStates 三个方法</p><ul><li>querySessionStates: tiproxy 在 tidb a 上执行 SHOW SESSION_STATES 获取到 session_token session_state</li><li>handshakeSecondTime: tiproxy 使用 session_token 认证方式登录到 tidb b</li><li>initSessionStates: tiproxy 登录成功后执行 SET SESSION_STATES &lsquo;%s&rsquo; 设置 tidb b 的 session_state</li></ul><p>补充：</p><ul><li>tiproxy 使用的 session token 的方式可以理解为 tidb 丰富了 mysql 协议，在 client 登录 server 的时候，除了账号密码这种mysql_native_password方式，还支持了账号token方式。</li><li>使用 session token 认证方式，要求整个tidb集群证书是一样的，这样tidb a签名，tidb b才可以验签通过。</li></ul><p>为了方式迁移期间，client还有新的会话，在执行 tryRedirect 前后使用 sync.Mutex 进行保护</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>func (mgr *BackendConnManager) processSignals(ctx context.Context) {
</span></span><span class=line><span class=cl>    for {
</span></span><span class=line><span class=cl>            // ...
</span></span><span class=line><span class=cl>            mgr.processLock.Lock()
</span></span><span class=line><span class=cl>            switch s {
</span></span><span class=line><span class=cl>            case signalTypeRedirect:
</span></span><span class=line><span class=cl>                mgr.tryRedirect(ctx)
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>            mgr.processLock.Unlock()
</span></span><span class=line><span class=cl>            // ...
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>func (mgr *BackendConnManager) ExecuteCmd(ctx context.Context, request []byte) (err error) {
</span></span><span class=line><span class=cl>    // ...
</span></span><span class=line><span class=cl>    mgr.processLock.Lock()
</span></span><span class=line><span class=cl>    defer mgr.processLock.Unlock()
</span></span><span class=line><span class=cl>    // ...
</span></span><span class=line><span class=cl>    waitingRedirect := mgr.redirectInfo.Load() != nil
</span></span><span class=line><span class=cl>    // ...
</span></span><span class=line><span class=cl>    if waitingRedirect {
</span></span><span class=line><span class=cl>        mgr.tryRedirect(ctx)
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    // ...
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><h3 id=4tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的 class=headerLink><a href=#4tiproxy%e5%9c%a8%e8%87%aa%e5%8a%a8%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1%e6%9c%9f%e9%97%b4%e9%81%87%e5%88%b0%e5%a4%84%e4%ba%8e%e6%9c%aa%e6%8f%90%e4%ba%a4%e4%ba%8b%e5%8a%a1%e7%9a%84session%e6%98%af%e6%80%8e%e4%b9%88%e7%ad%89%e5%be%85%e7%bb%93%e6%9d%9f%e7%9a%84 class=header-mark></a>4、tiproxy在自动负载均衡期间遇到处于未提交事务的session是怎么等待结束的？</h3><p>对于 tryRedirect 方法有两个地方被调用，即前文提到的 BackendConnManager::processSignals 和 BackendConnManager::ExecuteCmd</p><p>BackendConnManager::processSignals 只有在收到channe消息后立即出发一次，如果有未完成的事务就不再执行了。</p><p>所以为了保证迁移任务可继续，在 BackendConnManager::ExecuteCmd 中每次执行完 executeCmd 后尝试迁移，这样就能保证事务结束后立刻迁移。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>mgr</span> <span class=o>*</span><span class=nx>BackendConnManager</span><span class=p>)</span> <span class=nf>ExecuteCmd</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>request</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>waitingRedirect</span> <span class=o>:=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>redirectInfo</span><span class=p>.</span><span class=nf>Load</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>holdRequest</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>cmdProcessor</span><span class=p>.</span><span class=nf>executeCmd</span><span class=p>(</span><span class=nx>request</span><span class=p>,</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>clientIO</span><span class=p>,</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>backendIO</span><span class=p>.</span><span class=nf>Load</span><span class=p>(),</span> <span class=nx>waitingRedirect</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=nx>mgr</span><span class=p>.</span><span class=nx>cmdProcessor</span><span class=p>.</span><span class=nf>finishedTxn</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>waitingRedirect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>mgr</span><span class=p>.</span><span class=nf>tryRedirect</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>判断事务是否结束的 finishedTxn 方法逻辑：解析 client 的请求类型、解析 backend 的响应状态综合判断事务是否完成，此逻辑过于硬核，等以后研究明白后再分享吧。</p><p>有兴趣的读者可以分析下这段逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>cp</span> <span class=o>*</span><span class=nx>CmdProcessor</span><span class=p>)</span> <span class=nf>finishedTxn</span><span class=p>()</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>cp</span><span class=p>.</span><span class=nx>serverStatus</span><span class=o>&amp;</span><span class=p>(</span><span class=nx>StatusInTrans</span><span class=p>|</span><span class=nx>StatusQuit</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// If any result of the prepared statements is not fetched, we should wait.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>!</span><span class=nx>cp</span><span class=p>.</span><span class=nf>hasPendingPreparedStmts</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>cp</span> <span class=o>*</span><span class=nx>CmdProcessor</span><span class=p>)</span> <span class=nf>updatePrepStmtStatus</span><span class=p>(</span><span class=nx>request</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>serverStatus</span> <span class=kt>uint16</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>stmtID</span>         <span class=kt>int</span>
</span></span><span class=line><span class=cl>        <span class=nx>prepStmtStatus</span> <span class=kt>uint32</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>cmd</span> <span class=o>:=</span> <span class=nx>pnet</span><span class=p>.</span><span class=nf>Command</span><span class=p>(</span><span class=nx>request</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>cmd</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtSendLongData</span><span class=p>,</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtExecute</span><span class=p>,</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtFetch</span><span class=p>,</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtReset</span><span class=p>,</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtClose</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>stmtID</span> <span class=p>=</span> <span class=nb>int</span><span class=p>(</span><span class=nx>binary</span><span class=p>.</span><span class=nx>LittleEndian</span><span class=p>.</span><span class=nf>Uint32</span><span class=p>(</span><span class=nx>request</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=mi>5</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComResetConnection</span><span class=p>,</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComChangeUser</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>cp</span><span class=p>.</span><span class=nx>preparedStmtStatus</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kt>uint32</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=nx>cmd</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtSendLongData</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>prepStmtStatus</span> <span class=p>=</span> <span class=nx>StatusPrepareWaitExecute</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtExecute</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>serverStatus</span><span class=o>&amp;</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>ServerStatusCursorExists</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>prepStmtStatus</span> <span class=p>=</span> <span class=nx>StatusPrepareWaitFetch</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nx>pnet</span><span class=p>.</span><span class=nx>ComStmtFetch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>serverStatus</span><span class=o>&amp;</span><span class=nx>mysql</span><span class=p>.</span><span class=nx>ServerStatusLastRowSend</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>prepStmtStatus</span> <span class=p>=</span> <span class=nx>StatusPrepareWaitFetch</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>prepStmtStatus</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>cp</span><span class=p>.</span><span class=nx>preparedStmtStatus</span><span class=p>[</span><span class=nx>stmtID</span><span class=p>]</span> <span class=p>=</span> <span class=nx>prepStmtStatus</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>delete</span><span class=p>(</span><span class=nx>cp</span><span class=p>.</span><span class=nx>preparedStmtStatus</span><span class=p>,</span> <span class=nx>stmtID</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=总结 class=headerLink><a href=#%e6%80%bb%e7%bb%93 class=header-mark></a>总结</h2><p>本文从4个疑惑入手，阅读了下tiproxy的代码实现，都找到了对应的处理逻辑。</p><p>对比于tidb、tikv、pd等组件代码，tiproxy实简单很多，推荐大家学习下。</p><h2 id=彩蛋 class=headerLink><a href=#%e5%bd%a9%e8%9b%8b class=header-mark></a>彩蛋</h2><p>在梳理上面4个问题的时，理清思路后，绘制了如下的内部交互图，有兴趣的可以自己研究下，下篇文章我们将对其进行说明。</p><p><a class=lightgallery href=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png title=Img data-thumbnail=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png><img loading=lazy src=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png srcset="/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png, /images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png 1.5x, /images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png 2x" sizes=auto alt=/images/tiproxy-yuan-li-he-shi-xian.md/img-20230730171638.png></a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-07-30</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/tiproxy-yuan-li-he-shi-xian/index.md target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/tidb/>tidb</a>,&nbsp;<a href=/tags/database/>database</a>,&nbsp;<a href=/tags/tiproxy/>tiproxy</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/try-tiproxy/ class=prev rel=prev title="TiProxy 尝鲜"><i class="fas fa-angle-left fa-fw"></i>TiProxy 尝鲜</a>
<a href=/tidb-you-ya-guan-bi/ class=next rel=next title="TiDB 优雅关闭">TiDB 优雅关闭<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=giscus></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/>giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">happyuncle</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div id=cookieconsent-container></div><div class=assets><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{giscus:{darkTheme:"dark",dataCategory:"Announcements",dataCategoryId:"DIC_kwDOJFSaWc4CUpIr",dataEmitMetadata:"0",dataInputPosition:"top",dataLang:"en",dataMapping:"pathname",dataReactionsEnabled:"1",dataRepo:"HappyUncle/happyuncle.github.io",dataRepoId:"R_kgDOJFSaWQ",dataStrict:"0",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"desktop-header-typeit":"C4H","mobile-header-typeit":"C4H"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},table:{sort:!0},typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/giscus.min.js defer></script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/typeit/typeit.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/js/cookieconsent.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-T9314S6XRH")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-T9314S6XRH" async></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?2dac9531c61d782d11f76c2c92995a7c",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></div></body></html>